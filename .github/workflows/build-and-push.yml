name: Build and Push Docker Containers

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
      
      - name: Clone conformance-suite from GitLab
        run: |
          git clone --branch demo https://gitlab.com/openid/conformance-suite.git
          cd conformance-suite
          echo "Cloned repository at commit: $(git rev-parse HEAD)"
      
      - name: Run builder and build Docker images
        run: |
          cd conformance-suite
          MAVEN_CACHE=./m2 docker compose -f builder-compose.yml run builder
          docker compose build
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Tag and push Docker images
        run: |
          cd conformance-suite
          
          # Tag and push httpd image
          docker tag conformance-suite-httpd:latest ${{ env.REGISTRY }}/${{ github.repository }}/httpd:${{ github.sha }}
          docker tag conformance-suite-httpd:latest ${{ env.REGISTRY }}/${{ github.repository }}/httpd:latest
          
          # Tag and push server image
          docker tag conformance-suite-server:latest ${{ env.REGISTRY }}/${{ github.repository }}/server:${{ github.sha }}
          docker tag conformance-suite-server:latest ${{ env.REGISTRY }}/${{ github.repository }}/server:latest
          
          # Push images (only if not a PR)
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            docker push ${{ env.REGISTRY }}/${{ github.repository }}/httpd:${{ github.sha }}
            docker push ${{ env.REGISTRY }}/${{ github.repository }}/httpd:latest
            docker push ${{ env.REGISTRY }}/${{ github.repository }}/server:${{ github.sha }}
            docker push ${{ env.REGISTRY }}/${{ github.repository }}/server:latest
          fi
